#!/bin/bash

if [ "$1" = "" ]; then
    echo -e "\e[1;35m==================================\e[0m"
    echo -e "\e[1;32mModo de usar: $0 <arquivo.pcap>\e[0m"
    echo "Exemplo: $0 exemplo.pcap"
    exit 1
fi

if ! command -v tcpdump &> /dev/null; then
    echo "tcpdump não está instalado, tentando instalar..."
    sudo apt-get update && sudo apt-get install -y tcpdump
fi

if ! command -v jq &> /dev/null; then
    echo "jq não está instalado, tentando instalar..."
    sudo apt-get install -y jq
fi

echo -e "\e[1;35m========================================\e[0m"
echo -e "\e[1;32m[+] Analisando o arquivo: $1\e[0m"
echo -e "\e[1;35m=========================================\e[0m"

# Extrair IP do servidor baseado na flag [S] (primeira tentativa encontrada)
 IP_SERVIDOR=$(sudo tcpdump -nvr "$1" 'tcp' | grep '\[S\]' | awk '{split($3, a, "."); print a[1]"."a[2]"."a[3]"."a[4]}' | head -n 1)
 OPEN_PORT=$(sudo tcpdump -nvr "$1" 'tcp' | grep '\[S.\]' | awk -F, '{print $1}')
 echo "IP do servidor: $IP_SERVIDOR"

# Detecção de comportamento de malware baseado em tentativas de conexão [S]
sudo tcpdump -nvr "$1" 'tcp[tcpflags] & (tcp-syn) != 0' | awk '{print $3}' | awk -F. '{print $(NF)}' | sort | uniq -c | sort -nr | 
  while read COUNT PORT; do
    echo "Possível comportamento de malware detectado: $COUNT tentativa(s) na porta $PORT."
  done

# Obter subdomínio usando nslookup
SUBDOMINIO=$(nslookup $IP_SERVIDOR | awk '/name =/ {print $4}' | sed 's/\.$//')
echo "Subdomínio do servidor: $SUBDOMINIO"

echo -e "\e[1;35mEventos de porta aberta:\e[0m"
echo "$OPEN_PORT" | while read line; do
echo -e "\e[1;35m$line\e[0m"
done



API_KEY="apikeyvirustotal:cd7c6a226db0846de2046a735bbe9fe9f3ec0487391e436f0aa51158d7f4ab5b"
# Solicitação da API do VirusTotal
curl --silent --request GET \
     --url "https://www.virustotal.com/api/v3/ip_addresses/${IP_SERVIDOR}/resolutions" \
     --header "x-apikey: ${API_KEY}" \
     -o response.json

# Mostrar hostnames resolvidos para o IP
echo -e "\e[1;35m[+] Hostnames associados ao IP:\e[0m"
jq -r '.data[].attributes.host_name' response.json | while read HOSTNAME; do
    echo -e "\e[1;32m$HOSTNAME\e[0m"
done

